services:
    db:
        container_name: postgres_app
        image: postgres
        env_file: ./.env
        environment:
            - POSTGRES_USER=${POSTGRES_USER}
            - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
            - POSTGRES_DB=${POSTGRES_DB}
            - POSTGRES_MULTIPLE_DATABASES=${POSTGRES_MULTIPLE_DATABASES}
        restart: unless-stopped
        healthcheck:
            test: [ 'CMD-SHELL', '-d ${POSTGRES_DB} -U ${POSTGRES_USER}' ]
            interval: 5s
            timeout: 5s
            retries: 5
        ports:
            - "5432:5432"
        networks:
            - database
        command:
            - bash
            - c
            - |
              until psql -c "SELECT 1"; do sleep 1; done;
              psql -c "CREATE DATABASE ${{ secrets.POSTGRES_MULTIPLE_DATABASES }};"

        # psql -c "GRANT ALL PRIVILEGES ON DATABASE ${secrets.POSTGRES_MULTIPLE_DATABASES} TO $$POSTGRES_USER$$;"
        volumes:
            - ./init-databases.sh:/docker-entrypoint-initdb.d/init-databases.sh
            - postgres_data:/var/lib/postgresql/data

    backend:
        container_name: app
        build:
            dockerfile: ./Dockerfile
            context: .
        env_file: ./.env
        command:
            - bash
            - -c
            - |
                python3 ./manage.py makemigrations
                python3 ./manage.py migrate
                python3 ./manage.py collectstatic --clear --noinput
                python3 ./manage.py shell -c "
                from django.contrib.auth import get_user_model
                User = get_user_model()
                if not User.objects.filter(username='root').exists():
                    User.objects.create_superuser('root', 'admin@example.com', '123')
                    print('Superuser root created successfully')
                else:
                    print('Superuser root already exists')
                "
                python3 ./manage.py load_violations
                daphne -b 0.0.0.0 -p 8000 project.asgi:application

        volumes:
            - ./:/www/src
            - volume_static:/www/src/collectstatic
        depends_on:
            - db
        ports:
            - "8000:8000"
        networks:
            - database
            - backend
    nginx:
        container_name: nginx_app
        build:
            context: ./nginx
            dockerfile: Dockerfile
        depends_on:
            - backend
            - db
        volumes:
            - volume_static:/www/src/collectstatic
        restart: on-failure
        ports:
            - "80:80"
        networks:
            - backend
            - database
    celery:
        container_name: celery_app
        build:
            context: .
            dockerfile: ./Dockerfile  # Тот же Dockerfile, что и для backend
        env_file: ./.env
        command:
            - sh
            - -c
            - "celery -A project.celery worker --loglevel=info"

        volumes:
            - .:/www/src
        depends_on:
            - db
            - redis
        restart: unless-stopped
        networks:
            - queue
            - backend
            - database
    redis:
        container_name: wink_redis
        image: redis:7.2-alpine
        command: redis-server --appendonly yes
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 30s
            timeout: 10s
            retries: 3
        volumes:
            - redis_data:/data
        #depends_on:
            #-
        ports:
            -   "6379:6379"
        restart: unless-stopped
        networks:
            - queue

volumes:
    redis_data:
    volume_static:
    postgres_data:

networks:
    backend:
        driver: bridge
        driver_opts:
            com.docker.network.driver.mtu: 1450 # Option from REG.ru
    database:
        driver: bridge
        internal: true
        driver_opts:
            com.docker.network.driver.mtu: 1450 # Option from REG.ru
    queue:
        driver: bridge
        driver_opts:
            com.docker.network.driver.mtu: 1450 # Option from REG.ru
    frontend:
        driver: bridge
        driver_opts:
            com.docker.network.driver.mtu: 1450 # Option from REG.ru
